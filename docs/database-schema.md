# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

ReCoronã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¨å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®è©³ç´°èª¬æ˜ã§ã™ã€‚

## ğŸ“‹ ç›®æ¬¡

- [æ¦‚è¦](#æ¦‚è¦)
- [Enumsï¼ˆåˆ—æŒ™å‹ï¼‰](#enumsåˆ—æŒ™å‹)
- [èªè¨¼é–¢é€£ãƒ¢ãƒ‡ãƒ«](#èªè¨¼é–¢é€£ãƒ¢ãƒ‡ãƒ«)
- [ã‚³ã‚¢æ©Ÿèƒ½ãƒ¢ãƒ‡ãƒ«](#ã‚³ã‚¢æ©Ÿèƒ½ãƒ¢ãƒ‡ãƒ«)
- [ä½¿ç”¨é‡è¿½è·¡ãƒ¢ãƒ‡ãƒ«](#ä½¿ç”¨é‡è¿½è·¡ãƒ¢ãƒ‡ãƒ«)
- [ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—å›³](#ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—å›³)

## æ¦‚è¦

ReCoronã¯Prisma ORMã‚’ä½¿ç”¨ã—ã¦PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨é€£æºã—ã¦ã„ã¾ã™ã€‚ã‚¹ã‚­ãƒ¼ãƒã¯ä»¥ä¸‹ã®4ã¤ã®ä¸»è¦ã‚«ãƒ†ã‚´ãƒªã«åˆ†é¡ã•ã‚Œã¦ã„ã¾ã™ï¼š

1. **Enums** - åŸºæœ¬çš„ãªå‹å®šç¾©
2. **èªè¨¼é–¢é€£** - Better Authã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
3. **ã‚³ã‚¢æ©Ÿèƒ½** - ã‚¸ãƒ§ãƒ–ã¨APIã‚­ãƒ¼ç®¡ç†
4. **ä½¿ç”¨é‡è¿½è·¡** - èª²é‡‘ã¨æ‚ªç”¨é˜²æ­¢

---

## Enumsï¼ˆåˆ—æŒ™å‹ï¼‰

### Planï¼ˆãƒ—ãƒ©ãƒ³ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–™é‡‘ãƒ—ãƒ©ãƒ³ã‚’å®šç¾©ã—ã¾ã™ã€‚

| å€¤ | èª¬æ˜ | ã‚¸ãƒ§ãƒ–æ•° | æœˆæ¬¡å®Ÿè¡Œå›æ•° | æœ€å°å®Ÿè¡Œé–“éš” |
|---|---|---|---|---|
| `FREE` | ç„¡æ–™ãƒ—ãƒ©ãƒ³ | 5å€‹ | 500å› | 60åˆ† |
| `HOBBY` | è¶£å‘³ãƒ—ãƒ©ãƒ³ | 20å€‹ | 10,000å› | 30åˆ† |
| `PRO` | ãƒ—ãƒ­ãƒ—ãƒ©ãƒ³ | 100å€‹ | 50,000å› | 15åˆ† |

### Methodï¼ˆHTTPãƒ¡ã‚½ãƒƒãƒ‰ï¼‰

HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®šç¾©ã—ã¾ã™ã€‚

- `GET` - ãƒªã‚½ãƒ¼ã‚¹ã®å–å¾—
- `POST` - ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæˆ
- `PUT` - ãƒªã‚½ãƒ¼ã‚¹ã®å®Œå…¨æ›´æ–°
- `DELETE` - ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤
- `PATCH` - ãƒªã‚½ãƒ¼ã‚¹ã®éƒ¨åˆ†æ›´æ–°

### Typeï¼ˆå®Ÿè¡Œã‚¿ã‚¤ãƒ—ï¼‰

ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œæ–¹æ³•ã‚’å®šç¾©ã—ã¾ã™ã€‚

| å€¤ | èª¬æ˜ |
|---|---|
| `AUTO` | è‡ªå‹•å®Ÿè¡Œï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã«åŸºã¥ãï¼‰ |
| `MANUAL` | æ‰‹å‹•å®Ÿè¡Œï¼ˆAPIçµŒç”±ï¼‰ |

---

## èªè¨¼é–¢é€£ãƒ¢ãƒ‡ãƒ«

### Userï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç®¡ç†ã—ã¾ã™ã€‚Better Authã¨é€£æºã—ã¦ã„ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `name` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼å |
| `email` | String | âœ“ | - | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä¸€æ„ï¼‰ |
| `emailVerified` | Boolean | âœ“ | false | ãƒ¡ãƒ¼ãƒ«èªè¨¼æ¸ˆã¿ãƒ•ãƒ©ã‚° |
| `image` | String? | - | null | ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒURL |
| `plan` | Plan | âœ“ | FREE | æ–™é‡‘ãƒ—ãƒ©ãƒ³ |
| `isAdmin` | Boolean | âœ“ | false | ç®¡ç†è€…æ¨©é™ãƒ•ãƒ©ã‚° |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |
| `updatedAt` | DateTime | âœ“ | now() | æ›´æ–°æ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `sessions` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆ1å¯¾å¤šï¼‰
- `accounts` - OAuthé€£æºã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ1å¯¾å¤šï¼‰
- `jobs` - ä½œæˆã—ãŸã‚¸ãƒ§ãƒ–ï¼ˆ1å¯¾å¤šï¼‰
- `logs` - å®Ÿè¡Œãƒ­ã‚°ï¼ˆ1å¯¾å¤šï¼‰
- `apiKeys` - APIã‚­ãƒ¼ï¼ˆ1å¯¾å¤šï¼‰
- `monthlyUsages` - æœˆæ¬¡ä½¿ç”¨é‡ï¼ˆ1å¯¾å¤šï¼‰
- `dailyUsages` - æ—¥æ¬¡ä½¿ç”¨é‡ï¼ˆ1å¯¾å¤šï¼‰
- `resourceHistories` - ãƒªã‚½ãƒ¼ã‚¹å±¥æ­´ï¼ˆ1å¯¾å¤šï¼‰
- `WebhookJobs` - Webhookã‚¸ãƒ§ãƒ–ï¼ˆ1å¯¾å¤šï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `email` - ä¸€æ„åˆ¶ç´„

---

### Sessionï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | - | ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `token` | String | âœ“ | - | ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆä¸€æ„ï¼‰ |
| `expiresAt` | DateTime | âœ“ | - | æœ‰åŠ¹æœŸé™ |
| `ipAddress` | String? | - | null | ã‚¢ã‚¯ã‚»ã‚¹å…ƒIPã‚¢ãƒ‰ãƒ¬ã‚¹ |
| `userAgent` | String? | - | null | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ |
| `userId` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |
| `updatedAt` | DateTime | âœ“ | now() | æ›´æ–°æ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `user` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `token` - ä¸€æ„åˆ¶ç´„

---

### Accountï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰

OAuthé€£æºæƒ…å ±ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’ç®¡ç†ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | - | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `accountId` | String | âœ“ | - | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å´ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID |
| `providerId` | String | âœ“ | - | ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼IDï¼ˆgithub, googleç­‰ï¼‰ |
| `userId` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `accessToken` | String? | - | null | ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ |
| `refreshToken` | String? | - | null | ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ |
| `idToken` | String? | - | null | IDãƒˆãƒ¼ã‚¯ãƒ³ |
| `accessTokenExpiresAt` | DateTime? | - | null | ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ |
| `refreshTokenExpiresAt` | DateTime? | - | null | ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ |
| `scope` | String? | - | null | ã‚¹ã‚³ãƒ¼ãƒ— |
| `password` | String? | - | null | ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |
| `updatedAt` | DateTime | âœ“ | now() | æ›´æ–°æ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `user` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰

---

### Verificationï¼ˆæ¤œè¨¼ï¼‰

ãƒ¡ãƒ¼ãƒ«èªè¨¼ãªã©ã®æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç®¡ç†ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | - | æ¤œè¨¼IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `identifier` | String | âœ“ | - | è­˜åˆ¥å­ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ï¼‰ |
| `value` | String | âœ“ | - | æ¤œè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ |
| `expiresAt` | DateTime | âœ“ | - | æœ‰åŠ¹æœŸé™ |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |
| `updatedAt` | DateTime | âœ“ | now() | æ›´æ–°æ—¥æ™‚ |

---

## ã‚³ã‚¢æ©Ÿèƒ½ãƒ¢ãƒ‡ãƒ«

### Jobï¼ˆCronã‚¸ãƒ§ãƒ–ï¼‰

ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã•ã‚Œã‚‹HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç®¡ç†ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | cuid() | ã‚¸ãƒ§ãƒ–IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `userId` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `name` | String | âœ“ | - | ã‚¸ãƒ§ãƒ–å |
| `schedule` | String | âœ“ | - | Cronå¼ï¼ˆä¾‹: "0 9 * * *"ï¼‰ |
| `timezone` | String | âœ“ | "Asia/Tokyo" | ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ |
| `url` | String | âœ“ | - | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ˆURL |
| `method` | Method | âœ“ | GET | HTTPãƒ¡ã‚½ãƒƒãƒ‰ |
| `headers` | Json? | - | null | ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ |
| `body` | String? | - | null | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ |
| `enabled` | Boolean | âœ“ | true | æœ‰åŠ¹/ç„¡åŠ¹ãƒ•ãƒ©ã‚° |
| `lastRunAt` | DateTime? | - | null | æœ€çµ‚å®Ÿè¡Œæ—¥æ™‚ |
| `nextRunAt` | DateTime? | - | null | æ¬¡å›å®Ÿè¡Œäºˆå®šæ—¥æ™‚ |
| `count` | Int | âœ“ | 0 | å®Ÿè¡Œå›æ•° |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |
| `updatedAt` | DateTime | âœ“ | now() | æ›´æ–°æ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `user` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰
- `runningLogs` - å®Ÿè¡Œãƒ­ã‚°ï¼ˆ1å¯¾å¤šï¼‰
- `WebhookJobs` - Webhookã‚¸ãƒ§ãƒ–ï¼ˆ1å¯¾1ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `userId` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- `(enabled, nextRunAt)` - å®Ÿè¡Œå¯¾è±¡ã‚¸ãƒ§ãƒ–ã®æ¤œç´¢ç”¨

#### ä½¿ç”¨ä¾‹

```typescript
// ã‚¸ãƒ§ãƒ–ä½œæˆ
const job = await prisma.job.create({
  data: {
    userId: "user_123",
    name: "Daily Report",
    schedule: "0 9 * * *",
    timezone: "Asia/Tokyo",
    url: "https://api.example.com/report",
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ report: "daily" }),
  },
});
```

---

### RunningLogï¼ˆå®Ÿè¡Œãƒ­ã‚°ï¼‰

ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œçµæœã‚’è¨˜éŒ²ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | cuid() | ãƒ­ã‚°IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `jobId` | String? | - | null | ã‚¸ãƒ§ãƒ–IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ |
| `userId` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `type` | Type | âœ“ | AUTO | å®Ÿè¡Œã‚¿ã‚¤ãƒ— |
| `startedAt` | DateTime | âœ“ | - | å®Ÿè¡Œé–‹å§‹æ™‚åˆ» |
| `finishedAt` | DateTime | âœ“ | now() | å®Ÿè¡Œå®Œäº†æ™‚åˆ» |
| `url` | String | âœ“ | - | ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL |
| `status` | Int | âœ“ | - | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ |
| `responseBody` | String? | - | null | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ |
| `responseHeaders` | Json? | - | null | ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ |
| `durationMs` | Int | âœ“ | - | å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰ |
| `successful` | Boolean | âœ“ | true | æˆåŠŸ/å¤±æ•—ãƒ•ãƒ©ã‚° |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `job` - ã‚¸ãƒ§ãƒ–ï¼ˆå¤šå¯¾1ã€NULLè¨­å®šï¼‰
- `user` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `jobId` - ã‚¸ãƒ§ãƒ–ã”ã¨ã®ãƒ­ã‚°æ¤œç´¢ç”¨
- `createdAt` - æ—¥æ™‚é †ã®ãƒ­ã‚°å–å¾—ç”¨

#### æ³¨æ„äº‹é …

- `jobId`ã¯å‰Šé™¤ã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã®å ´åˆNULLã«ãªã‚Šã¾ã™
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤ã•ã‚Œã‚‹ã¨ãƒ­ã‚°ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™

---

### WebhookJobsï¼ˆWebhookã‚¸ãƒ§ãƒ–ï¼‰

å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã‚‹ã‚¸ãƒ§ãƒ–ã§ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | cuid() | Webhookã‚¸ãƒ§ãƒ–IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `userId` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `jobId` | String | âœ“ | - | ã‚¸ãƒ§ãƒ–IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ã€ä¸€æ„ï¼‰ |
| `endpoint` | String | âœ“ | - | Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| `headers` | Json? | - | null | ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |
| `updatedAt` | DateTime | âœ“ | now() | æ›´æ–°æ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `user` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰
- `job` - ã‚¸ãƒ§ãƒ–ï¼ˆ1å¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `userId` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- `jobId` - ä¸€æ„åˆ¶ç´„

---

### APIKeyï¼ˆAPIã‚­ãƒ¼ï¼‰

ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ†ã‚£ãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®èªè¨¼ã‚­ãƒ¼ã‚’ç®¡ç†ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | cuid() | APIã‚­ãƒ¼IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `userId` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `name` | String | âœ“ | - | APIã‚­ãƒ¼åï¼ˆè­˜åˆ¥ç”¨ï¼‰ |
| `keyHash` | String | âœ“ | - | ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒãƒƒã‚·ãƒ¥å€¤ï¼ˆä¸€æ„ï¼‰ |
| `lastUsed` | DateTime? | - | null | æœ€çµ‚ä½¿ç”¨æ—¥æ™‚ |
| `expiresAt` | DateTime? | - | null | æœ‰åŠ¹æœŸé™ |
| `count` | Int | âœ“ | 0 | ä½¿ç”¨å›æ•° |
| `scopes` | String[] | âœ“ | [] | ã‚¢ã‚¯ã‚»ã‚¹ã‚¹ã‚³ãƒ¼ãƒ— |
| `enabled` | Boolean | âœ“ | true | æœ‰åŠ¹/ç„¡åŠ¹ãƒ•ãƒ©ã‚° |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |
| `updatedAt` | DateTime | âœ“ | now() | æ›´æ–°æ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `user` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰
- `logs` - APIãƒ­ã‚°ï¼ˆ1å¯¾å¤šï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `userId` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- `keyHash` - ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ç”¨ï¼ˆä¸€æ„åˆ¶ç´„ï¼‰

#### ã‚¹ã‚³ãƒ¼ãƒ—

APIã‚­ãƒ¼ã«ã¯ä»¥ä¸‹ã®ã‚¹ã‚³ãƒ¼ãƒ—ã‚’è¨­å®šã§ãã¾ã™ï¼š

| ã‚¹ã‚³ãƒ¼ãƒ— | èª¬æ˜ |
|---|---|
| `read:jobs` | ã‚¸ãƒ§ãƒ–ã®èª­ã¿å–ã‚Š |
| `write:jobs` | ã‚¸ãƒ§ãƒ–ã®ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ |
| `read:keys` | APIã‚­ãƒ¼ã®èª­ã¿å–ã‚Š |
| `write:keys` | APIã‚­ãƒ¼ã®ä½œæˆãƒ»å‰Šé™¤ |

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- ãƒˆãƒ¼ã‚¯ãƒ³ã¯**ãƒãƒƒã‚·ãƒ¥åŒ–**ã•ã‚Œã¦ä¿å­˜ã•ã‚Œã¾ã™
- å®Ÿéš›ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä½œæˆæ™‚ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™
- æœ‰åŠ¹æœŸé™ã‚’è¨­å®šã§ãã¾ã™

---

### APILogï¼ˆAPIãƒ­ã‚°ï¼‰

APIã‚­ãƒ¼ã‚’ä½¿ç”¨ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å±¥æ­´ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | cuid() | ãƒ­ã‚°IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `apiKeyId` | String | âœ“ | - | APIã‚­ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `url` | String | âœ“ | - | ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL |
| `method` | Method | âœ“ | - | HTTPãƒ¡ã‚½ãƒƒãƒ‰ |
| `requestHeaders` | Json? | - | null | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ |
| `requestBody` | String? | - | null | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `apiKey` - APIã‚­ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `apiKeyId` - APIã‚­ãƒ¼ã”ã¨ã®ãƒ­ã‚°æ¤œç´¢ç”¨

---

## ä½¿ç”¨é‡è¿½è·¡ãƒ¢ãƒ‡ãƒ«

### MonthlyUsageï¼ˆæœˆæ¬¡ä½¿ç”¨é‡ï¼‰

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœˆã”ã¨ã®ä½¿ç”¨é‡ã¨èª²é‡‘æƒ…å ±ã‚’è¿½è·¡ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | cuid() | ä½¿ç”¨é‡IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `userId` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `year` | Int | âœ“ | - | å¹´ |
| `month` | Int | âœ“ | - | æœˆï¼ˆ1-12ï¼‰ |
| `totalExecutions` | Int | âœ“ | 0 | ç·ã‚¸ãƒ§ãƒ–å®Ÿè¡Œå›æ•° |
| `totalApiCalls` | Int | âœ“ | 0 | ç·APIå‘¼ã³å‡ºã—å›æ•° |
| `billedAmount` | Decimal | âœ“ | 0 | èª²é‡‘é¡ |
| `paid` | Boolean | âœ“ | false | æ”¯æ‰•ã„æ¸ˆã¿ãƒ•ãƒ©ã‚° |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |
| `updatedAt` | DateTime | âœ“ | now() | æ›´æ–°æ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `user` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `(userId, year, month)` - ä¸€æ„åˆ¶ç´„
- `userId` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- `(year, month)` - æœŸé–“æ¤œç´¢ç”¨

#### ç‰¹å¾´

- **å‰Šé™¤ã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã®ä½¿ç”¨é‡ã‚‚å«ã‚€**
- æ‚ªç”¨é˜²æ­¢ï¼ˆé »ç¹ãªå‰Šé™¤ãƒ»å†ä½œæˆï¼‰ã«ä½¿ç”¨
- èª²é‡‘è¨ˆç®—ã®åŸºç¤ãƒ‡ãƒ¼ã‚¿

---

### DailyUsageï¼ˆæ—¥æ¬¡ä½¿ç”¨é‡ï¼‰

ã‚ˆã‚Šç´°ã‹ã„ç²’åº¦ã§ã®ä½¿ç”¨é‡ã‚’è¿½è·¡ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | cuid() | ä½¿ç”¨é‡IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `userId` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `date` | Date | âœ“ | - | æ—¥ä»˜ |
| `executions` | Int | âœ“ | 0 | å®Ÿè¡Œå›æ•° |
| `apiCalls` | Int | âœ“ | 0 | APIå‘¼ã³å‡ºã—å›æ•° |
| `peakJobCount` | Int | âœ“ | 0 | æœ€å¤§ã‚¸ãƒ§ãƒ–æ•° |
| `peakApiKeyCount` | Int | âœ“ | 0 | æœ€å¤§APIã‚­ãƒ¼æ•° |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |
| `updatedAt` | DateTime | âœ“ | now() | æ›´æ–°æ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `user` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `(userId, date)` - ä¸€æ„åˆ¶ç´„
- `userId` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- `date` - æ—¥ä»˜æ¤œç´¢ç”¨

#### ç”¨é€”

- æ—¥æ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
- ãƒ”ãƒ¼ã‚¯æ™‚ã®æŠŠæ¡
- ã‚ˆã‚Šè©³ç´°ãªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ

---

### ResourceHistoryï¼ˆãƒªã‚½ãƒ¼ã‚¹å±¥æ­´ï¼‰

ã‚¸ãƒ§ãƒ–ã‚„APIã‚­ãƒ¼ã®ä½œæˆãƒ»å‰Šé™¤ã‚’è¿½è·¡ã—ã¾ã™ã€‚

#### ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | å¿…é ˆ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|---|---|---|---|---|
| `id` | String | âœ“ | cuid() | å±¥æ­´IDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `userId` | String | âœ“ | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¤–éƒ¨ã‚­ãƒ¼ï¼‰ |
| `resourceType` | String | âœ“ | - | ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ï¼ˆ"JOB" or "API_KEY"ï¼‰ |
| `resourceId` | String | âœ“ | - | ãƒªã‚½ãƒ¼ã‚¹ID |
| `action` | String | âœ“ | - | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ"CREATED" or "DELETED"ï¼‰ |
| `createdAt` | DateTime | âœ“ | now() | ä½œæˆæ—¥æ™‚ |

#### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

- `user` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆå¤šå¯¾1ã€ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤ï¼‰

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

- `(userId, resourceType)` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- `createdAt` - æ™‚ç³»åˆ—æ¤œç´¢ç”¨

#### æ‚ªç”¨é˜²æ­¢

ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä»¥ä¸‹ã®æ‚ªç”¨ã‚’é˜²ããŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ï¼š

```typescript
// ä¾‹: ä»Šæ—¥ã®ä½œæˆãƒ»å‰Šé™¤å›æ•°ã‚’ãƒã‚§ãƒƒã‚¯
const todayHistory = await prisma.resourceHistory.findMany({
  where: {
    userId: "user_123",
    resourceType: "JOB",
    createdAt: {
      gte: new Date(new Date().setHours(0, 0, 0, 0)),
    },
  },
});

const createdCount = todayHistory.filter(h => h.action === "CREATED").length;
const deletedCount = todayHistory.filter(h => h.action === "DELETED").length;

// ä»Šæ—¥5å›ä»¥ä¸Šä½œæˆå‰Šé™¤ã—ã¦ã„ã‚‹å ´åˆã¯åˆ¶é™
if (createdCount + deletedCount >= 10) {
  throw new Error("ä»Šæ—¥ã®ä½œæˆãƒ»å‰Šé™¤å›æ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸ");
}
```

---

## ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—å›³

```
User
â”œâ”€â”€ Session (1:å¤š)
â”œâ”€â”€ Account (1:å¤š)
â”œâ”€â”€ Job (1:å¤š)
â”‚   â”œâ”€â”€ RunningLog (1:å¤š)
â”‚   â””â”€â”€ WebhookJobs (1:1)
â”œâ”€â”€ APIKey (1:å¤š)
â”‚   â””â”€â”€ APILog (1:å¤š)
â”œâ”€â”€ MonthlyUsage (1:å¤š)
â”œâ”€â”€ DailyUsage (1:å¤š)
â””â”€â”€ ResourceHistory (1:å¤š)
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

è¤‡æ•°ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã™ã‚‹å ´åˆã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ï¼š

```typescript
await prisma.$transaction([
  prisma.job.create({ /* ... */ }),
  prisma.resourceHistory.create({
    data: {
      userId: "user_123",
      resourceType: "JOB",
      resourceId: jobId,
      action: "CREATED",
    },
  }),
  prisma.dailyUsage.update({ /* ... */ }),
]);
```

### 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ´»ç”¨

é »ç¹ã«æ¤œç´¢ã•ã‚Œã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™ï¼š

```typescript
// âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ï¼ˆé«˜é€Ÿï¼‰
await prisma.job.findMany({
  where: {
    userId: "user_123",
    enabled: true,
  },
});

// âŒ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ´»ç”¨ã—ã¦ã„ãªã„ï¼ˆä½é€Ÿï¼‰
await prisma.job.findMany({
  where: {
    name: { contains: "report" },
  },
});
```

### 3. ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰å‰Šé™¤

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã¨é–¢é€£ãƒ‡ãƒ¼ã‚¿ã‚‚è‡ªå‹•å‰Šé™¤ã•ã‚Œã¾ã™ï¼š

```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤æ™‚ã«è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ã‚‚ã®ï¼š
// - Session
// - Account
// - Jobï¼ˆâ†’ RunningLog, WebhookJobsã‚‚å‰Šé™¤ï¼‰
// - APIKeyï¼ˆâ†’ APILogã‚‚å‰Šé™¤ï¼‰
// - MonthlyUsage
// - DailyUsage
// - ResourceHistory
await prisma.user.delete({
  where: { id: "user_123" },
});
```

---

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ

```bash
npx prisma migrate dev --name add_new_feature
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨

```bash
# é–‹ç™ºç’°å¢ƒ
npx prisma migrate dev

# æœ¬ç•ªç’°å¢ƒ
npx prisma migrate deploy
```

### Prisma Clientã®å†ç”Ÿæˆ

ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´å¾Œã¯å¿…ãšå®Ÿè¡Œï¼š

```bash
npx prisma generate
```

---

## å‚è€ƒãƒªãƒ³ã‚¯

- [Prisma Documentation](https://www.prisma.io/docs)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Better Auth Documentation](https://www.better-auth.com/docs)
